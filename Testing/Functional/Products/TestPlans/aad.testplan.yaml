ProductName: aad
TestPlan:
  - PolicyId: MS.AAD.1.1v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.1.1v1 ReportOnly
        Preconditions:
          - Command: UpdateConditionalAccessPolicyByName
            Splat:
              displayName: Live - Block legacy authentication
              updates: 
                state: enabledForReportingButNotEnforced
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.1.1v1 Default
        Preconditions:
          - Command: UpdateConditionalAccessPolicyByName
            Splat:
              displayName: Live - Block legacy authentication
              updates:
                state: enabled
        Postconditions: []
        ExpectedResult: true       
  - PolicyId: MS.AAD.2.1v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.2.1v1 Report Only
        Preconditions:
          - Command: UpdateConditionalAccessPolicyByName
            Splat:
              displayName: Live - Risky Users Block Access
              updates: 
                state: enabledForReportingButNotEnforced
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.2.1v1 Default
        Preconditions:
          - Command: UpdateConditionalAccessPolicyByName
            Splat:
              displayName: Live - Risky Users Block Access
              updates:
                state: enabled
        Postconditions: [] 
        ExpectedResult: true
  - PolicyId: MS.AAD.2.2v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.2.2v1 Not Checked
        Preconditions: []
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
  - PolicyId: MS.AAD.2.3v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.2.3v1 Default
        Preconditions: []
        Postconditions: []
        ExpectedResult: false
  - PolicyId: MS.AAD.3.1v1
    TestDriver: RunCached
    Tests:
      - TestDescription: MS.AAD.3.1v1 Bad Authentication Strength
        Preconditions:
          - Command: UpdateProviderExport
            Splat:
              Updates:
                - Key: "conditional_access_policies"
                  Value:
                    - Conditions:
                        Applications:
                          IncludeApplications: 
                            - "All"
                          ExcludeApplications: []  
                        Users:
                          IncludeUsers:
                            - "All"
                      GrantControls:
                        AuthenticationStrength:
                          AllowedCombinations:
                            - "windowsHelloForBusiness"
                            - "Super Strength"
                            - "x509CertificateMultiFactor"
                      State: "enabled"
                      DisplayName: "MS.AAD.3.1v1 Bad Authentication Strength"
        Postconditions: []
        ExpectedResult: false        
      - TestDescription: MS.AAD.3.1v1 Default
        Preconditions:
          - Command: UpdateProviderExport
            Splat:
              Updates:
                - Key: "conditional_access_policies"
                  Value:
                    - Conditions:
                        Applications:
                          IncludeApplications: 
                            - "All"
                          ExcludeApplications: []
                        Users:
                          IncludeUsers:
                            - "All"
                      GrantControls:
                        AuthenticationStrength:
                          AllowedCombinations:
                            - "windowsHelloForBusiness"
                            - "fido2"
                            - "x509CertificateMultiFactor"
                      State: "enabled"
                      DisplayName: "Test Policy - MS.AAD.3.1v1 Default"
        Postconditions: []
        ExpectedResult: false
  - PolicyId: MS.AAD.3.2v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.3.2v1 MFA Not Required
        Preconditions:
          - Command: UpdateConditionalAccessPolicyByName
            Splat:
              displayName: Live - MFA Required for Everyone
              updates: 
                state: enabledForReportingButNotEnforced
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.3.2v1 Default
        Preconditions:
          - Command: UpdateConditionalAccessPolicyByName
            Splat:
              displayName: Live - MFA Required for Everyone
              updates: 
                state: enabled
        Postconditions: []
        ExpectedResult: true
  - PolicyId: MS.AAD.3.3v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.3.3v1 Not Checked
        Preconditions: []
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
  - PolicyId: MS.AAD.3.4v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.3.4v1 Not Checked
        Preconditions: []
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false 
  - PolicyId: MS.AAD.3.5v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.3.5v1 Not Checked
        Preconditions: []
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
  - PolicyId: MS.AAD.3.6v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.3.6v1 Report Only
        Preconditions:
          - Command: UpdateConditionalAccessPolicyByName
            Splat:
              displayName: Live - MFA required for Highly Privileged Roles
              updates: 
                state: enabled
        Postconditions: []
        ExpectedResult: true
      - TestDescription: MS.AAD.3.6v1 Default
        Preconditions:
          - Command: UpdateConditionalAccessPolicyByName
            Splat:
              displayName: Live - MFA required for Highly Privileged Roles
              updates: 
                state: disabled
        Postconditions: []
        ExpectedResult: false
  - PolicyId: MS.AAD.3.7v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.3.7v1 Default
        Preconditions: []
        Postconditions: []
        ExpectedResult: false
  - PolicyId: MS.AAD.3.8v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.3.8v1 Default
        Preconditions: []
        Postconditions: []
        ExpectedResult: false
  - PolicyId: MS.AAD.4.1v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.4.1v1 Not Checked
        Preconditions: []
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
  - PolicyId: MS.AAD.5.1v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.5.1v1 Allow 
        Preconditions:
          - Command: Update-MgPolicyAuthorizationPolicy
            Splat:
              AuthorizationPolicyId: authorizationPolicy
              DefaultUserRolePermissions:
                AllowedToCreateApps: true
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.5.1v1 Default 
        Preconditions:
          - Command: Update-MgPolicyAuthorizationPolicy
            Splat:
              AuthorizationPolicyId: authorizationPolicy
              DefaultUserRolePermissions:
                AllowedToCreateApps: false
        Postconditions: []
        ExpectedResult: true  
  - PolicyId: MS.AAD.5.2v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.5.2v1 Default
        Preconditions: []
        Postconditions: []
        ExpectedResult: true
  - PolicyId: MS.AAD.5.3v1
    TestDriver: RunCached
    Tests:
      - TestDescription: MS.AAD.5.3v1 No Admin Consent Request Policy Enabled
        Preconditions:
          - Command: UpdateProviderExport
            Splat:
              Updates:
                - Key: "admin_consent_policies"
                  Value:
                    - Id: "Test Policy - MS.AAD.5.3v1 No Admin Consent Request Policy Enabled"
                      IsEnabled: false
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.5.3v1 Default
        Preconditions:
          - Command: UpdateProviderExport
            Splat:
              Updates:
                - Key: "admin_consent_policies"
                  Value:
                    - Id: "Test Policy - MS.AAD.5.3v1 Default"
                      IsEnabled: true
        Postconditions: []
        ExpectedResult: true
  - PolicyId: MS.AAD.5.4v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.5.4v1 Default
        Preconditions: []
        Postconditions: []
        ExpectedResult: true
  - PolicyId: MS.AAD.6.1v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.6.1v1 Not Checked
        Preconditions: []
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
  - PolicyId: MS.AAD.7.1v1
    TestDriver: RunCached
    Tests:
      - TestDescription: MS.AAD.7.1v1 To Many Admin
        Preconditions:
          - Command: UpdateProviderExport
            Splat:
              Updates:
                - Key: "privileged_users"
                  Value:
                    User1:
                      DisplayName: "Test User1"
                      roles: 
                        - "Privileged Role Administrator"
                        - "Global Administrator"
                    User2:
                      DisplayName: "Test User2"
                      roles: 
                        - "Global Administrator"
                    User3:
                      DisplayName: "Test User3"
                      roles: 
                        - "Privileged Role Administrator"
                        - "Global Administrator"
                    User4:
                      DisplayName: "Test User4"
                      roles: 
                        - "Global Administrator"
                    User5:
                      DisplayName: "Test User5"
                      roles: 
                        - "Privileged Role Administrator"
                        - "Global Administrator"
                    User6:
                      DisplayName: "Test User6"
                      roles: 
                        - "Global Administrator"
                    User7:
                      DisplayName: "Test User7"
                      roles: 
                        - "Privileged Role Administrator"
                        - "Global Administrator"
                    User8:
                      DisplayName: "Test User8"
                      roles: 
                        - "Global Administrator"
                    User9:
                      DisplayName: "Test User9"
                      roles: 
                        - "Global Administrator"
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.7.1v1 To Few Admin
        Preconditions: 
          - Command: UpdateProviderExport
            Splat:
              Updates:
                - Key: "privileged_users"
                  Value:
                    User1:
                      DisplayName: "Test User1"
                      roles: 
                        - "Privileged Role Administrator"
                        - "Global Administrator"
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.7.1v1 Default
        Preconditions: 
          - Command: UpdateProviderExport
            Splat:
              Updates:
                - Key: "privileged_users"
                  Value:
                    User1:
                      DisplayName: "Test User1"
                      roles: 
                        - "Privileged Role Administrator"
                        - "Global Administrator"
                    User2:
                      DisplayName: "Test User2"
                      roles: 
                        - "Global Administrator"
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.7.1v1 Default
        Preconditions: 
          - Command: UpdateProviderExport
            Splat:
              Updates:
                - Key: "privileged_users"
                  Value:
                    User1:
                      DisplayName: "Test User1"
                      roles: 
                        - "Privileged Role Administrator"
                        - "Global Administrator"
                    User2:
                      DisplayName: "Test User2"
                      roles: 
                        - "Global Administrator"
        Postconditions: []
        ExpectedResult: false
  - PolicyId: MS.AAD.7.2v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.7.2v1 Not Checked
        Preconditions: []
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
  - PolicyId: MS.AAD.7.3v1
    TestDriver: RunCached
    Tests:
      - TestDescription: MS.AAD.7.3v1 On Prem Admin
        Preconditions:  
          - Command: UpdateProviderExport
            Splat:
              Updates:
                - Key: "privileged_users"
                  Value:
                    User1:
                      DisplayName: "Test User1"
                      OnPremisesImmutableId: "Test On-Prem User1"
                      roles: 
                        - "Privileged Role Administrator"
                        - "Global Administrator"
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.7.3v1 Default
        Preconditions:  
          - Command: UpdateProviderExport
            Splat:
              Updates:
                - Key: "privileged_users"
                  Value:
                    User1:
                      DisplayName: "Test User1"
                      OnPremisesImmutableId: null
                      roles: 
                        - "Privileged Role Administrator"
                        - "Global Administrator"
                    User2:
                      DisplayName: "Test User2"
                      OnPremisesImmutableId: null
                      roles: 
                        - "Global Administrator"
        Postconditions: []
        ExpectedResult: true
  - PolicyId: MS.AAD.7.4v1
    TestDriver: RunCached
    Tests:
      - TestDescription: MS.AAD.7.4v1 Default
        Preconditions: []
        Postconditions: []
        ExpectedResult: false
  - PolicyId: MS.AAD.7.5v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.7.5v1 Default
        Preconditions: []
        Postconditions: []
        ExpectedResult: false
  - PolicyId: MS.AAD.7.6v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.7.6v1 Default
        Preconditions: []
        Postconditions: []
        ExpectedResult: true
  - PolicyId: MS.AAD.7.7v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.7.7v1 Default
        Preconditions: []
        Postconditions: []
        ExpectedResult: false
  - PolicyId: MS.AAD.7.8v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.7.8v1 Default
        Preconditions: []
        Postconditions: []
        ExpectedResult: true
  - PolicyId: MS.AAD.7.9v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.7.9v1 Default
        Preconditions: []
        Postconditions: []
        ExpectedResult: false
  - PolicyId: MS.AAD.8.1v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.8.1v1 Restricted access
        Preconditions: 
          - Command: Update-MgPolicyAuthorizationPolicy
            Splat:
              AuthorizationPolicyId: authorizationPolicy
              GuestUserRoleId: "2af84b1e-32c8-42b7-82bc-daa82404023b"
        Postconditions: []
        ExpectedResult: true
      - TestDescription: MS.AAD.8.1v1 Same as member users
        Preconditions: 
          - Command: Update-MgPolicyAuthorizationPolicy
            Splat:
              AuthorizationPolicyId: authorizationPolicy
              GuestUserRoleId: "a0b1b346-4d3e-4e8b-98f8-753987be4970"
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.8.1v1 Default
        Preconditions: 
          - Command: Update-MgPolicyAuthorizationPolicy
            Splat:
              AuthorizationPolicyId: authorizationPolicy
              GuestUserRoleId: "10dae51f-b6af-4016-8d66-8c2a99b929b3"
        Postconditions: []
        ExpectedResult: true
  - PolicyId: MS.AAD.8.2v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.8.2v1 Everyone
        Preconditions:
          - Command: Update-MgPolicyAuthorizationPolicy
            Splat:
              AuthorizationPolicyId: authorizationPolicy
              AllowInvitesFrom: everyone
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.8.2v1 Default
        Preconditions:
          - Command: Update-MgPolicyAuthorizationPolicy
            Splat:
              AuthorizationPolicyId: authorizationPolicy
              AllowInvitesFrom: adminsAndGuestInviters
        Postconditions: []
        ExpectedResult: true
  - PolicyId: MS.AAD.8.3v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.8.3v1 Not Checked
        Preconditions: []
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false

ProductName: aad
TestPlan:
  - PolicyId: MS.AAD.1.1v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.1.1v1 ReportOnly
        Preconditions:
          - Command: UpdateConditionalAccessPolicyByName
            Splat:
              displayName: MS.AAD.1.1v1 Legacy authentication SHALL be blocked
              updates: 
                state: enabledForReportingButNotEnforced
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.1.1v1 Default
        Preconditions:
          - Command: UpdateConditionalAccessPolicyByName
            Splat:
              displayName: MS.AAD.1.1v1 Legacy authentication SHALL be blocked
              updates:
                state: enabled
        Postconditions: []
        ExpectedResult: true       
  - PolicyId: MS.AAD.2.1v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.2.1v1 Report Only
        Preconditions:
          - Command: UpdateConditionalAccessPolicyByName
            Splat:
              displayName: MS.AAD.2.1v1 Users detected as high risk SHALL be blocked
              updates: 
                state: enabledForReportingButNotEnforced
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.2.1v1 Default
        Preconditions:
          - Command: UpdateConditionalAccessPolicyByName
            Splat:
              displayName: MS.AAD.2.1v1 Users detected as high risk SHALL be blocked
              updates:
                state: enabled
        Postconditions: [] 
        ExpectedResult: true
  - PolicyId: MS.AAD.2.2v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.2.2v1 Not Checked
        Preconditions: []
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
  - PolicyId: MS.AAD.2.3v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.2.1v1 Report Only 
        Preconditions:
          - Command: UpdateConditionalAccessPolicyByName
            Splat:
              displayName: MS.AAD.2.3v1 Sign-ins detected as high risk SHALL be blocked
              updates:
                state: enabledForReportingButNotEnforced
        Postconditions: [] 
        ExpectedResult: false
      - TestDescription: MS.AAD.2.1v1 Default
        Preconditions:
          - Command: UpdateConditionalAccessPolicyByName
            Splat:
              displayName: MS.AAD.2.3v1 Sign-ins detected as high risk SHALL be blocked
              updates:
                state: enabled
        Postconditions: 
          - Command: UpdateConditionalAccessPolicyByName
            Splat:
              displayName: MS.AAD.2.3v1 Sign-ins detected as high risk SHALL be blocked
              updates:
                state: enabledForReportingButNotEnforced            
        ExpectedResult: true
  - PolicyId: MS.AAD.3.1v1
    TestDriver: RunCached
    Tests:
      - TestDescription: MS.AAD.3.1v1 Bad Authentication Strength
        Preconditions:
          - Command: UpdateCachedConditionalAccessPolicyByName
            Splat:
              displayName: Automated Test 1 - DO NOT MODIFY
              updates:
                State: enabled  
                Conditions.Applications.IncludeApplications: 
                  - "All"
                Conditions.Applications.ExcludeApplications: [] 
                'Conditions.Users.IncludeUsers':
                  - "All"
                GrantControls.AuthenticationStrength.AllowedCombinations:    
                  - "windowsHelloForBusiness"
                  - "Super Strength"
                  - "x509CertificateMultiFactor"  
        Postconditions: []
        ExpectedResult: false        
      - TestDescription: MS.AAD.3.1v1 Default
        Preconditions:
          - Command: UpdateCachedConditionalAccessPolicyByName
            Splat:
              displayName: Automated Test 1 - DO NOT MODIFY
              updates:
                State: enabled  
                Conditions.Applications.IncludeApplications: 
                  - "All"
                Conditions.Applications.ExcludeApplications: [] 
                Conditions.Users.IncludeUsers:
                  - "All"
                GrantControls.AuthenticationStrength.AllowedCombinations:    
                  - "windowsHelloForBusiness"
                  - "fido2"
                  - "x509CertificateMultiFactor"  
        Postconditions: []
        ExpectedResult: true
  - PolicyId: MS.AAD.3.2v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.3.2v1 MFA Not Required
        Preconditions:
          - Command: UpdateConditionalAccessPolicyByName
            Splat:
              displayName: MS.AAD.3.2v1 If phishing-resistant MFA has not been enforced yet, then an alternative MFA method SHALL be enforced for all users
              updates: 
                state: enabledForReportingButNotEnforced
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.3.2v1 Default
        Preconditions:
          - Command: UpdateConditionalAccessPolicyByName
            Splat:
              displayName: MS.AAD.3.2v1 If phishing-resistant MFA has not been enforced yet, then an alternative MFA method SHALL be enforced for all users
              updates: 
                state: enabled
        Postconditions:
          - Command: UpdateConditionalAccessPolicyByName
            Splat:
              displayName: MS.AAD.3.2v1 If phishing-resistant MFA has not been enforced yet, then an alternative MFA method SHALL be enforced for all users
              updates: 
                state: enabledForReportingButNotEnforced        
        ExpectedResult: true
  - PolicyId: MS.AAD.3.3v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.3.3v1 Not Checked
        Preconditions: []
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
  - PolicyId: MS.AAD.3.4v1
    TestDriver: RunCached
    Tests:
      - TestDescription: MS.AAD.3.4v1 preMigration
        Preconditions:
          - Command: UpdateProviderExport
            Splat:
              updates:
                'authentication_method[0].PolicyMigrationState': preMigration  
        Postconditions: []
        ExpectedResult: false 
      - TestDescription: MS.AAD.3.4v1 Default
        Preconditions:
          - Command: UpdateProviderExport
            Splat:
              updates:
                'authentication_method[0].PolicyMigrationState': migrationComplete  
        Postconditions: []
        ExpectedResult: true 
  - PolicyId: MS.AAD.3.5v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.3.5v1 Not Checked
        Preconditions: []
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
  - PolicyId: MS.AAD.3.6v1
    TestDriver: RunCached
    Tests:
      - TestDescription: MS.AAD.3.6v1 Report Only
        Preconditions:
          - Command: UpdateCachedConditionalAccessPolicyByName
            Splat:
              displayName: Automated Test 1 - DO NOT MODIFY
              updates:
                State: enabled  
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.3.6v1 Default
        Preconditions:
          - Command: UpdateCachedConditionalAccessPolicyByName
            Splat:
              displayName: Live - MFA required for Highly Privileged Roles
              updates: 
                state: disabled
        Postconditions: []
        ExpectedResult: false
  - PolicyId: MS.AAD.3.7v1
    TestDriver: RunCached
    Tests:
      - TestDescription: MS.AAD.3.7v1 compliantDevice
        Preconditions:
          - Command: UpdateCachedConditionalAccessPolicyByName
            Splat:
              displayName: Automated Test 1 - DO NOT MODIFY
              updates:
                State: enabled  
                GrantControls.BuiltInControls: 
                  - "compliantDevice"
                Conditions.Users.IncludeUsers:
                  - "All" 
                Conditions.Applications.ExcludeApplications:
                  - "All"         
        Postconditions: []
        ExpectedResult: true
      - TestDescription: MS.AAD.3.7v1 domainJoinedDevice
        Preconditions:
          - Command: UpdateCachedConditionalAccessPolicyByName
            Splat:
              displayName: Automated Test 1 - DO NOT MODIFY
              updates:
                State: enabled  
                GrantControls.BuiltInControls: 
                  - "domainJoinedDevice"
                Conditions.Users.IncludeUsers:
                  - "All" 
                Conditions.Applications.ExcludeApplications:
                  - "All"         
        Postconditions: []
        ExpectedResult: true    
      - TestDescription: MS.AAD.3.7v1 Default
        Preconditions:
          - Command: UpdateCachedConditionalAccessPolicyByName
            Splat:
              displayName: Automated Test 1 - DO NOT MODIFY
              updates:
                State: enabled  
                GrantControls.BuiltInControls: 
                  - "compliantDevice"
                  - "domainJoinedDevice"
                Conditions.Users.IncludeUsers:
                  - "All" 
                Conditions.Applications.ExcludeApplications:
                  - "All"         
        Postconditions: []
        ExpectedResult: true
  - PolicyId: MS.AAD.3.8v1
    TestDriver: RunCached
    Tests:
      - TestDescription: MS.AAD.3.8v1 No registersecurityinfo
        Preconditions:
          - Command: UpdateCachedConditionalAccessPolicyByName
            Splat:
              displayName: Automated Test 1 - DO NOT MODIFY
              updates:
                State: enabled  
                GrantControls.BuiltInControls: 
                  - "compliantDevice"
                  - "domainJoinedDevice"
                Conditions.Applications.IncludeUserActions:
                  - "no action"
                Conditions.Users.IncludeUsers:
                  - "All"  
        Postconditions: []
        ExpectedResult: false    
      - TestDescription: MS.AAD.3.8v1 Default
        Preconditions:
          - Command: UpdateCachedConditionalAccessPolicyByName
            Splat:
              displayName: Automated Test 1 - DO NOT MODIFY
              updates:
                State: enabled  
                GrantControls.BuiltInControls: 
                  - "compliantDevice"
                  - "domainJoinedDevice"
                Conditions.Applications.IncludeUserActions:
                  - "urn:user:registersecurityinfo"
                Conditions.Users.IncludeUsers:
                  - "All"  
        Postconditions: []
        ExpectedResult: true
  - PolicyId: MS.AAD.4.1v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.4.1v1 Not Checked
        Preconditions: []
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
  - PolicyId: MS.AAD.5.1v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.5.1v1 Allow 
        Preconditions:
          - Command: Update-MgPolicyAuthorizationPolicy
            Splat:
              AuthorizationPolicyId: authorizationPolicy
              DefaultUserRolePermissions:
                AllowedToCreateApps: true
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.5.1v1 Default 
        Preconditions:
          - Command: Update-MgPolicyAuthorizationPolicy
            Splat:
              AuthorizationPolicyId: authorizationPolicy
              DefaultUserRolePermissions:
                AllowedToCreateApps: false
        Postconditions: []
        ExpectedResult: true  
  - PolicyId: MS.AAD.5.2v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.5.2v1 Default
        Preconditions:
          - Command: Update-MgPolicyAuthorizationPolicy
            Splat:
              AuthorizationPolicyId: authorizationPolicy
              DefaultUserRolePermissions:
                DefaultUserRolePermissions: true
        Postconditions: []
        ExpectedResult: true
  - PolicyId: MS.AAD.5.3v1
    TestDriver: RunScuba
    ToDo: Work API. How to use switch parameter?
    Tests:
      - TestDescription: MS.AAD.5.3v1 No Admin Consent Request Policy Enabled
        Preconditions:
          - Command: Update-MgPolicyAdminConsentRequestPolicy
            Splat:
              IsEnabled: false
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.5.3v1 Default
        Preconditions:
          - Command: Update-MgPolicyAdminConsentRequestPolicy
            Splat:
              IsEnabled: true
        Postconditions: []
        ExpectedResult: true
  - PolicyId: MS.AAD.5.4v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.5.4v1 Default
        Preconditions: 
          - Command: Update-MgDirectorySetting
            Splat:
                IsEnabled: true
            Comment: Need to find appropraite PS commands    
        Postconditions: []
        ExpectedResult: true
  - PolicyId: MS.AAD.6.1v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.6.1v1 Not Checked
        Preconditions: []
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
  - PolicyId: MS.AAD.7.1v1
    TestDriver: RunCached
    Tests:
      - TestDescription: MS.AAD.7.1v1 To Many Admin
        Preconditions:
          - Command: UpdateProviderExport
            Splat:
              Updates:
                privileged_users:
                  User1:
                    DisplayName: Test User1
                    roles: 
                      - Privileged Role Administrator
                      - Global Administrator
                  User2:
                    DisplayName: Test User2
                    roles: 
                      - Global Administrator
                  User3:
                    DisplayName: Test User3
                    roles: 
                      - Privileged Role Administrator
                      - Global Administrator
                  User4:
                    DisplayName: Test User4
                    roles: 
                      - Global Administrator
                  User5:
                    DisplayName: Test User5
                    roles: 
                      - Privileged Role Administrator
                      - Global Administrator
                  User6:
                    DisplayName: Test User6
                    roles: 
                      - Global Administrator
                  User7:
                    DisplayName: Test User7
                    roles: 
                      - Privileged Role Administrator
                      - Global Administrator
                  User8:
                    DisplayName: Test User8
                    roles: 
                      - Global Administrator
                  User9:
                    DisplayName: Test User9
                    roles: 
                      - Global Administrator
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.7.1v1 To Few Admin
        Preconditions: 
          - Command: UpdateProviderExport
            Splat:
              Updates:
                privileged_users:
                  User1:
                    DisplayName: Test User1
                    roles: 
                      - Privileged Role Administrator
                      - Global Administrator
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.7.1v1 Default
        Preconditions: 
          - Command: UpdateProviderExport
            Splat:
              Updates:
                privileged_users:
                  User1:
                    DisplayName: Test User1
                    roles: 
                      - Privileged Role Administrator
                      - Global Administrator
                  User2:
                    DisplayName: Test User2
                    roles: 
                      - Global Administrator
        Postconditions: []
        ExpectedResult: true
  - PolicyId: MS.AAD.7.2v1
    TestDriver: RunCached
    Tests:
      - TestDescription: MS.AAD.7.2v1 Low Score
        Preconditions: 
          - Command: UpdateProviderExport
            Splat:
              Updates:
                secure_score[0].Score: 0.2
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.7.2v1 High Score
        Preconditions: 
          - Command: UpdateProviderExport
            Splat:
              Updates:
                secure_score[0].Score: 1
        Postconditions: []
        ExpectedResult: true        
  - PolicyId: MS.AAD.7.3v1
    TestDriver: RunCached
    ToDo: Change to RunCached?
    Tests:
      - TestDescription: MS.AAD.7.3v1 On Prem Admin
        Preconditions:  
          - Command: UpdateProviderExport
            Splat:
              Updates:
                privileged_users:
                  User1:
                    DisplayName: Test User1
                    OnPremisesImmutableId: Test On-Prem User1
                    roles: 
                      - Privileged Role Administrator
                      - Global Administrator
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.7.3v1 Default
        Preconditions:  
          - Command: UpdateProviderExport
            Splat:
              Updates:
                privileged_users:
                  User1:
                    DisplayName: Test User1
                    OnPremisesImmutableId: null
                    roles: 
                      - Privileged Role Administrator
                      - Global Administrator
                  User2:
                    DisplayName: Test User2
                    OnPremisesImmutableId: null
                    roles: 
                      - Global Administrator
        Postconditions: []
        ExpectedResult: true
  - PolicyId: MS.AAD.7.4v1
    TestDriver: RunCached
    ToDo: Change to RunScuba? Need better tests
    Tests:
      - TestDescription: MS.AAD.7.4v1 Has End Date
        Preconditions:  
          - Command: UpdateProviderExport
            Splat:
              Updates:
                privileged_roles[0].Assignments[0].EndDateTime: "/Date(1672947244397)/"
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.7.4v1 Default
        Preconditions:  
          - Command: UpdateProviderExport
            Splat:
              Updates:
                privileged_roles[0].Assignments[0].EndDateTime: null
        Postconditions: []
        ExpectedResult: true          
  - PolicyId: MS.AAD.7.5v1
    TestDriver: RunCached
    ToDo: Change to RunScuba? Need better tests
    Tests:
      - TestDescription: MS.AAD.7.5v1 Null Start
        Preconditions:           
          - Command: UpdateProviderExport
            Splat:
              Updates:
                privileged_roles[0].Assignments[0].StartDateTime: null
        Postconditions: []
        ExpectedResult: false
  - PolicyId: MS.AAD.7.6v1
    TestDriver: RunCached
    Tests:
      - TestDescription: MS.AAD.7.6v1 Default
        Preconditions:  
          - Command: UpdateProviderExport
            Splat:
              Updates:
                privileged_roles[0].Rules[0].Id: Approval_EndUser_Assignment
                privileged_roles[0].Rules[0].AdditionalProperties.setting.isApprovalRequired: false
                privileged_roles[0].DisplayName: Not Global Administrator
        Postconditions: []
        ExpectedResult: false
  - PolicyId: MS.AAD.7.7v1
    TestDriver: RunCached
    ToDo: Changed to RunScuba
    Tests:
      - TestDescription: MS.AAD.7.7v1 Default
        Preconditions:  
          - Command: UpdateProviderExport
            Splat:
              Updates:
                privileged_roles[0].Rules[0].Id: Notification_Admin_Admin_Assignment
                privileged_roles[0].Rules[0].AdditionalProperties.notificationRecipients[0]: "user@somewhere.org"
                privileged_roles[0].DisplayName: Global Administrator
        Postconditions: []
        ExpectedResult: false
  - PolicyId: MS.AAD.7.8v1
    TestDriver: RunCached
    ToDo: Changed to RunScuba
    Tests:
      - TestDescription: MS.AAD.7.8v1 No notificationRecipients
        Preconditions:  
          - Command: UpdateProviderExport
            Splat:
              Updates:
                privileged_roles[0].Rules[0].Id: Notification_Admin_EndUser_Assignment
                privileged_roles[0].Rules[0].AdditionalProperties.notificationType: Email
                privileged_roles[0].Rules[0].AdditionalProperties:
                  notificationRecipients: []
                privileged_roles[0].DisplayName: Global Administrator
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.7.8v1 Default
        Preconditions:  
          - Command: UpdateProviderExport
            Splat:
              Updates:
                privileged_roles[0].Rules[0].Id: Notification_Admin_EndUser_Assignment
                privileged_roles[0].Rules[0].AdditionalProperties.notificationType: Email
                privileged_roles[0].Rules[0].AdditionalProperties:
                  notificationRecipients:
                    - 'someone@somewhere.org'
                privileged_roles[0].DisplayName: Global Administrator
        Postconditions: []
        ExpectedResult: true    
  - PolicyId: MS.AAD.7.9v1
    TestDriver: RunCached
    ToDo: Changed to RunScuba
    Tests:
      - TestDescription: MS.AAD.7.9v1 Default
        Preconditions:  
          - Command: UpdateProviderExport
            Splat:
              Updates:
                privileged_roles[0].Rules[0].Id: Notification_Admin_EndUser_Assignment
                privileged_roles[0].Rules[0].AdditionalProperties.notificatinType: Email
                privileged_roles[0].Rules[0].AdditionalProperties.notificationRecipients: []
                privileged_roles[0].DisplayName: Privileged Role Administrator
        Postconditions: []
        ExpectedResult: false
  - PolicyId: MS.AAD.8.1v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.8.1v1 Restricted access
        Preconditions: 
          - Command: Update-MgPolicyAuthorizationPolicy
            Splat:
              AuthorizationPolicyId: authorizationPolicy
              GuestUserRoleId: "2af84b1e-32c8-42b7-82bc-daa82404023b"
        Postconditions: []
        ExpectedResult: true
      - TestDescription: MS.AAD.8.1v1 Same as member users
        Preconditions: 
          - Command: Update-MgPolicyAuthorizationPolicy
            Splat:
              AuthorizationPolicyId: authorizationPolicy
              GuestUserRoleId: "a0b1b346-4d3e-4e8b-98f8-753987be4970"
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.8.1v1 Default
        Preconditions: 
          - Command: Update-MgPolicyAuthorizationPolicy
            Splat:
              AuthorizationPolicyId: authorizationPolicy
              GuestUserRoleId: "10dae51f-b6af-4016-8d66-8c2a99b929b3"
        Postconditions: []
        ExpectedResult: true
  - PolicyId: MS.AAD.8.2v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.8.2v1 Everyone
        Preconditions:
          - Command: Update-MgPolicyAuthorizationPolicy
            Splat:
              AuthorizationPolicyId: authorizationPolicy
              AllowInvitesFrom: everyone
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.AAD.8.2v1 Default
        Preconditions:
          - Command: Update-MgPolicyAuthorizationPolicy
            Splat:
              AuthorizationPolicyId: authorizationPolicy
              AllowInvitesFrom: adminsAndGuestInviters
        Postconditions: []
        ExpectedResult: true
  - PolicyId: MS.AAD.8.3v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.8.3v1 Not Checked
        Preconditions: []
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
